# Only run against master
trigger:
  - master

# Don't run against PRs
pr: none

variables:
  -group: MinecraftServer
  AppServicePlan_Name: minecraft-tekkit
  Authentication_UserName: minecraft-admin
  ResourceGroup_Location: 'Australia East'
  ResourceGroup_Name: minecraft-tekkit
  WebApp_BuildConfiguration: Release
  WebApp_OutputFolder: $(Build.ArtifactStagingDirectory)/WebApp
  WebApp_ProjectDirectory: $(Build.SourcesDirectory)/src/$(WebApp_ProjectName)
  WebApp_ProjectFile: $(WebApp_ProjectDirectory)/$(WebApp_ProjectName).csproj
  WebApp_ProjectName: MinecraftServer.Web
  WebApp_SiteName: minecraft-tekkit
  VirtualMachine_Name: minecraft-tekkit

stages:
  # Download and build the project
  - stage: Build
    displayName: Build
    jobs:
      - job: run_build
        pool:
          vmImage: "windows-latest"
        steps:

          ## Run the dotnet build/publish
          - script: |
              dotnet publish $(WebApp_ProjectFile) --configuration $(WebApp_BuildConfiguration) --output $(WebApp_OutputFolder)
            displayName: Publish dotnet web app

          - task: CopyFiles@2
            displayName: Copy ARM template
            inputs:
              contents: $(Build.SourcesDirectory)/azure-deploy.json
              targetFolder: $(Build.ArtifactStagingDirectory)

          ## Archive the files into a zip file for publishing
          - task: ArchiveFiles@2
            displayName: Zip build artifacts
            inputs:
              rootFolderOrFile: $(WebApp_OutputFolder)
              archiveType: "zip"
              archiveFile: "$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip"
              includeRootFolder: false

          ## Publish the zip file
          - task: PublishBuildArtifacts@1
            displayName: Publish build artifacts
            inputs:
              pathtoPublish: "$(Build.ArtifactStagingDirectory)"
              artifactName: drop

  # Deploy the resources and application
  - stage: DeployResourceGroup
    displayName: Deploy Resource Group
    jobs:
    - deployment: Production
      displayName: Deploy Resource Group
      pool:
        vmImage: 'windows-latest'
      environment: 'production'
      strategy:
        runOnce:
          deploy:
            steps:
            - download: current
              artifact: drop
            - task: AzureResourceGroupDeployment@2
              displayName: 'ARM deployment'
              inputs:
                azureSubscription: '2fb0e5d3-72a4-49c4-80a8-892de5ea8bd7'
                resourceGroupName: $(ResourceGroup_Name)
                location: $(ResourceGroup_Location)
                csmFile: $(Pipeline.Workspace)/drop/azure-deploy.json
                deploymentMode: 'Incremental'
                overrideParameters: >-
                  -AppServicePlan_Name "$(AppServicePlan_Name)"
                  -Authentication_UserName "$(Authentication_UserName)"
                  -Authentication_PasswordOrKey "$(Authentication_PasswordOrKey)"
                  -VirtualMachine_Name  "$(VirtualMachine_Name)"
                  -WebApp_SiteName "$(WebApp_SiteName)"


